<!DOCTYPE html>
<html>
<head>
    <title>Sensor Werte</title>
    <style>
        .content-table {
            border-collapse: collapse;
            border-width: 3px;
            margin: 25px 0;
            font-size: 2.9em;
            text-align: left;
            line-height: 1.4em;
            min-width: 400px;
            border-radius: 5px 5px 0 0;
            overflow: hidden;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.15);
            margin-left: 0.3em;
            margin-top: 0.5em;
        }
        .content-table th {
            padding: 12px 15px;
            background-color: #0ef25e;
            font-weight: bold;
            font-style: italic;
        }
        .content-table td {
            padding: 12px 15px;
        }
        .content-table tbody tr {
            border-bottom: 2px solid #dddddd;
        }
        .content-table tbody tr:nth-of-type(even) {
            background-color: #cdcbcb72;
        }
        .old-data {
            background-color: #ffcccc !important; /* Light red background for old data with higher priority */
        }
        .no-underline {
            text-decoration: none; /* Remove underline */
            color: blue; /* Set text color to blue */
        }

    </style>
</head>
<body>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <table width=95% class="content-table">
        <thead>
            <tr style="border-bottom:2pt solid black;">
                <th>Sensoren</th>
                <th>Temp</th>
                <th>Feuchte</th>
                <th>CO<FONT SIZE="6">2</FONT></th>
     <!--           <th>Zeit</th> -->
            </tr>
        </thead>
        <tbody>
            <tr id="row_out" style="border-bottom:2pt solid black;">
                <td><b>Outdoor</b></td>
                <td>&nbsp;<span id="temp_out"></span></td>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
  <!--              <td>&nbsp;<span id="time_out"></span></td> -->
            </tr>
            <tr id="row_WZ">
                <td><b>Wohnzimmer</b></td>
                <td>&nbsp;<span id="temp_WZ"></span></td>
                <td>&nbsp;<span id="hum_WZ"></span>%</td>
                <td>&nbsp;</td>
   <!--             <td>&nbsp;<span id="time_WZ"></span></td> -->
            </tr>
            <tr id="row_SZ">
                <td><b><a href="SZ.html class="no-underline">Schlafzimmer</a></b></td>
                <td>&nbsp;<span id="temp_SZ"></span></td>
                <td>&nbsp;<span id="hum_SZ"></span>%</td>
                <td>&nbsp;<span id="co2_SZ"></span></td>
     <!--           <td>&nbsp;<span id="temp_SZ_Time"></span></td> -->
            </tr>
            <tr id="row_BadU">
                <td><b>Bad (unten)</b></td>
                <td>&nbsp;<span id="temp_BadU"></span></td>
                <td>&nbsp;<span id="hum_BadU"></span>%</td>
                <td>&nbsp;</td>
      <!--          <td>&nbsp;<span id="time_BadU"></span></td> -->
            </tr>
            <tr id="row_AZ">
                <td><b>Arbeitszimmer</b></td>
                <td>&nbsp;<span id="temp_AZ"></span></td>
                <td>&nbsp;<span id="hum_AZ"></span>%</td>
                <td>&nbsp;</td>
        <!--         <td>&nbsp;<span id="time_AZ"></span></td> -->
            </tr>
            <tr id="row_B" style="border-bottom:2pt solid black;">
                <td><b>B&uuml;ro</b></td>                
                <td>&nbsp;<span id="temp_B"></span></td>
                <td>&nbsp;<span id="hum_B"></span>%</td>        
                <td>&nbsp;<span id="co2_B"></span></td>        
        <!--         <td>&nbsp;<span id="time_AZ"></span></td> -->
            </tr>
            <tr id="row_WG">
                <td><b>Wintergarten</b></td>
                <td>&nbsp;<span id="temp_WG"></span></td>
                <td>&nbsp;<span id="hum_WG"></span>%</td>
                <td>&nbsp;</td>
        <!--         <td>&nbsp;<span id="time_WG"></span></td> -->
            </tr>
            <tr id="row_Keller">
                <td><b>Keller</b></td>
                <td>&nbsp;<span id="temp_Keller"></span></td>
                <td>&nbsp;<span id="hum_Keller"></span>%</td>
                <td>&nbsp;</td>
        <!--         <td>&nbsp;<span id="time_Keller"></span></td> -->
            </tr>
            <tr id="row_Schuppen" style="border-bottom:2pt solid black;">
                <td><b>Schuppen</b></td>
                <td>&nbsp;<span id="temp_Schuppen"></span></td>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
       <!--          <td>&nbsp;<span id="temp_Schuppen_Time"></span></td> -->
            

        </tbody>
    </table>
    <br/>
<br/>
<br/>


 <table width=95% class="content-table">
        <tr>
        <tr style="border-bottom:2pt solid black;">
            <th>
                Gas
            </th>
            <th>
                aktuell
            </th>
            <th>
                Tag
            </th>
            <th>
                Monat
            </th>  
            <th>
            <!--    Zeit -->
            </th>           
        </tr>
        <tr id="row_Radon" style="border-bottom:2pt solid black;">
            <td><b>Radon</b></td>
            <td>
                &nbsp;
                <span id="radon_now"></span>
            </td>
            <td>&nbsp;<span id="radon_day"></span></td>
            <td>&nbsp;<span id="radon_month"></span></td>
            <td>&nbsp;
                <!--       <span id="time_Radon"></span> -->
            </td>
        </tr>
        
       
           
    </table>

    <br/>
<br/>
<br/>
<table width=95% class="content-table">
        <tr>
            <td>
                <b>Strom: </b>
            </td>
            <td>
                <span id="power"></span> W
            </td>
            <td>
                (VT:
                <span id="power_vt"></span> kWh)
            </td>
        </tr>
        <tr>
            <td>
                <b>Gas:</b>
            </td>
            <td>
                <span id="heat"></span> m&sup3/10min
            </td>
            <td>
                (VT:
                <span id="heat_vt"></span> m&sup3)
            </td>
        </tr>
    </table>

<br/>
<br/>
<br/>
    <button style="border-radius: 20px;display:block; margin: 0 auto;font-size:3em;height:100px;width:350px"
        onclick="window.location.reload();">aktualisieren</button>
    <br/>
    <br/>
    <br/>
    <br/><br/>
    <br/>
    <br/>
    <br/>
    <div style="width:95%;padding-left: 0;padding-right: 0;margin-left: auto;margin-right: auto;display: block;">
        <canvas id="Gas_Chart"></canvas>
    </div>

    <br />
    <br />
    <br />

    <div style="width:95%;padding-left: 0;padding-right: 0;margin-left: auto;margin-right: auto;display: block;">
        <canvas id="Strom_Chart"></canvas>
    </div>

    <br />
    <br />
    <br />

    <div style="width:95%;padding-left: 0;padding-right: 0;margin-left: auto;margin-right: auto;display: block;">
        <canvas id="Einspeise_Chart"></canvas>
    </div>
            
        
            

    <script>
        // API URLs
        const api_urls = {
            'temp_out': 'https://api.thingspeak.com/channels/1658417/fields/1/last.json?api_key=RFUT0UIWTJFFKUIF',
            'time_out': 'https://api.thingspeak.com/channels/1658417/fields/1/last_data_age.json?api_key=RFUT0UIWTJFFKUIF',

            'temp_WZ': 'https://api.thingspeak.com/channels/2826784/fields/1/last.json?api_key=NAOV5H2S8G4E6REJ',
            'hum_WZ': 'https://api.thingspeak.com/channels/2826784/fields/3/last.json?api_key=NAOV5H2S8G4E6REJ',
            'time_WZ': 'https://api.thingspeak.com/channels/2826784/fields/1/last_data_age.json?api_key=NAOV5H2S8G4E6REJ',

            'temp_SZ': 'https://api.thingspeak.com/channels/1652172/fields/3/last.json?api_key=JFXYLE5IUPX44M9U',
            'hum_SZ': 'https://api.thingspeak.com/channels/1652172/fields/2/last.json?api_key=JFXYLE5IUPX44M9U',
            'co2_SZ': 'https://api.thingspeak.com/channels/1652172/fields/1/last.json?api_key=JFXYLE5IUPX44M9U',
            'temp_SZ_Time': 'https://api.thingspeak.com/channels/1652172/fields/3/last_data_age.json?api_key=JFXYLE5IUPX44M9U',

            'temp_BadU': 'https://api.thingspeak.com/channels/1967668/fields/1/last.json?api_key=N3V8AL6ONIG9IZQ1',
            'hum_BadU': 'https://api.thingspeak.com/channels/1967668/fields/2/last.json?api_key=N3V8AL6ONIG9IZQ1',
            'time_BadU': 'https://api.thingspeak.com/channels/1967668/fields/1/last_data_age.json?api_key=N3V8AL6ONIG9IZQ1',

            'temp_AZ': 'https://api.thingspeak.com/channels/1963228/fields/1/last.json?api_key=I3R524KUNGLN0FST',
            'hum_AZ': 'https://api.thingspeak.com/channels/1963228/fields/2/last.json?api_key=I3R524KUNGLN0FST',
            'time_AZ': 'https://api.thingspeak.com/channels/1963228/fields/1/last_data_age.json?api_key=I3R524KUNGLN0FST',

            'temp_WG': 'https://api.thingspeak.com/channels/1912395/fields/1/last.json?api_key=F41ZWHUBMQWU4NR1',
            'hum_WG': 'https://api.thingspeak.com/channels/1912395/fields/2/last.json?api_key=F41ZWHUBMQWU4NR1',
            'time_WG': 'https://api.thingspeak.com/channels/1912395/fields/1/last_data_age.json?api_key=F41ZWHUBMQWU4NR1',

            'temp_Keller': 'https://api.thingspeak.com/channels/1951954/fields/1/last.json?api_key=YVTMSTCJDVGTHZ3R',
            'hum_Keller': 'https://api.thingspeak.com/channels/1951954/fields/2/last.json?api_key=YVTMSTCJDVGTHZ3R',
            'time_Keller': 'https://api.thingspeak.com/channels/1951954/fields/1/last_data_age.json?api_key=YVTMSTCJDVGTHZ3R',

            'temp_Schuppen': 'https://api.thingspeak.com/channels/1687414/fields/1/last.json?api_key=BTPWE1MJR9CLOT1T',
            'temp_Schuppen_Time': 'https://api.thingspeak.com/channels/1687414/fields/1/last_data_age.json?api_key=BTPWE1MJR9CLOT1T',

	        'Radon_now': 'https://api.thingspeak.com/channels/2841427/fields/1/last.json?api_key=ELN7AALPJ599IZO4',
	        'Radon_day': 'https://api.thingspeak.com/channels/2841427/fields/2/last.json?api_key=ELN7AALPJ599IZO4',
	        'Radon_month': 'https://api.thingspeak.com/channels/2841427/fields/3/last.json?api_key=ELN7AALPJ599IZO4',
	        'time_radon': 'https://api.thingspeak.com/channels/2841427/fields/1/last_data_age.json?api_key=ELN7AALPJ599IZO4',

            'co2_B': 'https://api.thingspeak.com/channels/2841427/fields/4/last.json?api_key=ELN7AALPJ599IZO4',
	        'temp_B': 'https://api.thingspeak.com/channels/2841427/fields/5/last.json?api_key=ELN7AALPJ599IZO4',
	        'hum_B': 'https://api.thingspeak.com/channels/2841427/fields/6/last.json?api_key=ELN7AALPJ599IZO4',
            'time_B': 'https://api.thingspeak.com/channels/2841427/fields/4/last_data_age.json?api_key=ELN7AALPJ599IZO4',

	        'Power': 'https://api.thingspeak.com/channels/1927492/fields/2/last.json?api_key=S0EWJ14ZBRUVTZ0O',
            'Power_VT': 'https://api.thingspeak.com/channels/1967479/fields/1/last.json?api_key=SMC8MLG4MPL18AMQ',
            'Heat': 'https://api.thingspeak.com/channels/1933511/fields/2/last.json?api_key=M0GU27NYGAZ7CDEA',
            'Heat_VT': 'https://api.thingspeak.com/channels/1933511/fields/3/last.json?api_key=M0GU27NYGAZ7CDEA'



        };

        // Time limits for each sensor
        const timeLimits = {
            'row_out': 4000,
            'row_WZ': 4000,
            'row_SZ': 4000,
            'row_BadU': 4000,
            'row_AZ': 4000,
            'row_B': 4000,
            'row_WG': 4000,
            'row_Keller': 4000,
            'row_Schuppen': 4000,
            'row_Radon': 4000	
        };

        async function fetchData(url, elementId, field) {
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                const data = await response.json();
                console.log(`Fetched data for ${elementId}:`, data);
                let value = Number.parseFloat(data[field]);
                if (elementId.startsWith("hum_") || elementId.startsWith("radon_") || elementId === "co2_SZ" || elementId === "power" || elementId === "co2_B") {
                    document.getElementById(elementId).textContent = value.toFixed(0);
                } else {
                    document.getElementById(elementId).textContent = value.toFixed(1);
                }
            } catch (error) {
                console.error(`Error fetching data for ${elementId}:`, error);
                document.getElementById(elementId).textContent = "NA";
            }
        }

        async function fetchTime(url, elementId) {
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                const data = await response.json();
                console.log(`Fetched time data for ${elementId}:`, data);
                const timeValue = Number.parseFloat(data.last_data_age).toFixed(0);
                document.getElementById(elementId).textContent = timeValue;
                return timeValue;
            } catch (error) {
                console.error(`Error fetching time for ${elementId}:`, error);
                document.getElementById(elementId).textContent = "NA";
                return "NA";
            }
        }

        async function highlightRowsIfOld(times) {
            const [time_out, time_WZ, time_SZ, time_BadU, time_AZ, time_WG, time_Keller, time_Schuppen, time_Radon] = times;

            if (time_out !== "NA" && Number(time_out) > timeLimits['row_out']) {
                document.getElementById('row_out').classList.add('old-data');
            }
            if (time_WZ !== "NA" && Number(time_WZ) > timeLimits['row_WZ']) {
                document.getElementById('row_WZ').classList.add('old-data');
            }
            if (time_SZ !== "NA" && Number(time_SZ) > timeLimits['row_SZ']) {
                document.getElementById('row_SZ').classList.add('old-data');
            }
            if (time_BadU !== "NA" && Number(time_BadU) > timeLimits['row_BadU']) {
                document.getElementById('row_BadU').classList.add('old-data');
            }
            if (time_AZ !== "NA" && Number(time_AZ) > timeLimits['row_AZ']) {
                document.getElementById('row_AZ').classList.add('old-data');
            }
            if (time_B !== "NA" && Number(time_B) > timeLimits['row_B']) {
                document.getElementById('row_B').classList.add('old-data');
            }
            if (time_WG !== "NA" && Number(time_WG) > timeLimits['row_WG']) {
                document.getElementById('row_WG').classList.add('old-data');
            }
            if (time_Keller !== "NA" && Number(time_Keller) > timeLimits['row_Keller']) {
                document.getElementById('row_Keller').classList.add('old-data');
            }
            if (time_Schuppen !== "NA" && Number(time_Schuppen) > timeLimits['row_Schuppen']) {
                document.getElementById('row_Schuppen').classList.add('old-data');
            }
            if (time_Radon !== "NA" && Number(time_Radon) > timeLimits['row_Radon']) {
                document.getElementById('row_Radon').classList.add('old-data');
            }

        }

        // Fetch data for each sensor and highlight rows if data is old
        async function initialize() {
            const fetchDataPromises = [
                fetchData(api_urls.temp_out, 'temp_out', 'field1'),
                fetchData(api_urls.temp_WZ, 'temp_WZ', 'field1'),
                fetchData(api_urls.hum_WZ, 'hum_WZ', 'field3'),
                fetchData(api_urls.temp_SZ, 'temp_SZ', 'field3'),
                fetchData(api_urls.hum_SZ, 'hum_SZ', 'field2'),
                fetchData(api_urls.co2_SZ, 'co2_SZ', 'field1'),
                fetchData(api_urls.temp_BadU, 'temp_BadU', 'field1'),
                fetchData(api_urls.hum_BadU, 'hum_BadU', 'field2'),
                fetchData(api_urls.temp_AZ, 'temp_AZ', 'field1'),
                fetchData(api_urls.hum_AZ, 'hum_AZ', 'field2'),
                fetchData(api_urls.co2_B, 'co2_B', 'field4'),
                fetchData(api_urls.temp_B, 'temp_B', 'field5'),
                fetchData(api_urls.hum_B, 'hum_B', 'field6'),
                fetchData(api_urls.temp_WG, 'temp_WG', 'field1'),
                fetchData(api_urls.hum_WG, 'hum_WG', 'field2'),
                fetchData(api_urls.temp_Keller, 'temp_Keller', 'field1'),
                fetchData(api_urls.hum_Keller, 'hum_Keller', 'field2'),
                fetchData(api_urls.temp_Schuppen, 'temp_Schuppen', 'field1'),
		        fetchData(api_urls.Radon_now, 'radon_now', 'field1'),
                fetchData(api_urls.Radon_day, 'radon_day', 'field2'),
                fetchData(api_urls.Radon_month, 'radon_month', 'field3'),
                fetchData(api_urls.Power, 'power', 'field2'),
                fetchData(api_urls.Power_VT, 'power_vt', 'field1'),
                fetchData(api_urls.Heat, 'heat', 'field2'),
                fetchData(api_urls.Heat_VT, 'heat_vt', 'field3')

            ];

            const fetchTimePromises = [
                fetchTime(api_urls.time_out, 'time_out'),
                fetchTime(api_urls.time_WZ, 'time_WZ'),
                fetchTime(api_urls.temp_SZ_Time, 'temp_SZ_Time'),
                fetchTime(api_urls.time_BadU, 'time_BadU'),
                fetchTime(api_urls.time_AZ, 'time_AZ'),
                fetchTime(api_urls.time_B, 'time_B'),
                fetchTime(api_urls.time_WG, 'time_WG'),               
                fetchTime(api_urls.time_Keller, 'time_Keller'),
                fetchTime(api_urls.temp_Schuppen_Time, 'temp_Schuppen_Time'),
		        fetchTime(api_urls.time_radon, 'time_Radon')
            ];

            await Promise.all(fetchDataPromises);

            const times = await Promise.all(fetchTimePromises);

            await highlightRowsIfOld(times);
        }

        async function getHeatVerbrauchData() {
            const response = await fetch(
                'https://api.thingspeak.com/channels/1956802/fields/1.json?api_key=7D6EGNJ4CQQR22IB&results=14');
            console.log(response);
            const data = await response.json();
            console.log(data);
            length = data.feeds.length;
            console.log(length);

            values = [];
            for (i = 0; i < length; i++) {
                values.push(data.feeds[i].field1);
            }

            Chart.defaults.font.size = 30;

            new Chart('Gas_Chart', {
                type: 'bar',
                data: {
                    labels: ['-14', '-13', '-12', '-11','-10', '-9', '-8', '-7', '-6', '-5', '-4', '-3', '-2', '-1'],
                    datasets: [{
                        label: 'Gas-Verbrauch [m3]',
                        hoverBackgroundColor: 'lightGreen',
                        data: values,
                        borderWidth: 1
                    }]
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });

        }

        async function getStromVerbrauchData() {
            const response = await fetch(
                'https://api.thingspeak.com/channels/1967479/fields/1.json?api_key=SMC8MLG4MPL18AMQ&results=14');
            console.log(response);
            const data = await response.json();
            console.log(data);
            length = data.feeds.length;
            console.log(length);

            values = [];
            for (i = 0; i < length; i++) {
                values.push(data.feeds[i].field1);
            }

            Chart.defaults.font.size = 30;

            new Chart('Strom_Chart', {
                type: 'bar',
                data: {
                    labels: ['-14', '-13', '-12', '-11','-10', '-9', '-8', '-7', '-6', '-5', '-4', '-3', '-2', '-1'],
                    datasets: [{
                        label: 'Strom-Verbrauch [kWh]',
                        backgroundColor: '#FFB1C1',
                        hoverBackgroundColor: 'lightGreen',
                        data: values,
                        borderWidth: 1
                    }]
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });

        }

async function getStromEinspeisungData() {
            const response = await fetch(
                'https://api.thingspeak.com/channels/2520182/fields/2.json?api_key=Q9RYVPPIHU2ZY4X4&results=14');
            console.log(response);
            const data = await response.json();
            console.log(data);
            length = data.feeds.length;
            console.log(length);

            values = [];
            for (i = 0; i < length; i++) {
                values.push(data.feeds[i].field2);
            }

            Chart.defaults.font.size = 30;

            new Chart('Einspeise_Chart', {
                type: 'bar',
                data: {
                    labels: ['-14', '-13', '-12', '-11','-10', '-9', '-8', '-7', '-6', '-5', '-4', '-3', '-2', '-1'],
                    datasets: [{
                        label: 'Strom-Einspeisung [kWh]',
                        backgroundColor: '#B1C1FF',
                        hoverBackgroundColor: 'lightGreen',
                        data: values,
                        borderWidth: 1
                    }]
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });

        }

            
            
        getHeatVerbrauchData();
        getStromVerbrauchData();
        getStromEinspeisungData();

        initialize();
    </script>
</body>
</html>
