<!DOCTYPE html>
<html>
<head>
    <title>Charts</title>
    <meta charset="UTF-8">
    <style>
        .chart-container {
            width: 90%;
            margin: auto;
        }
        .chart-container:not(:last-of-type) {
            margin-bottom: 100px; /* Increase the spacing between the charts to 100px for all but the last chart */
        }
        .main-title {
            text-align: center;
            font-size: 72px; /* Slightly larger font size for the main title */
            margin-top: 20px;
            margin-bottom: 50px; /* Increase margin-bottom for more distance below the main title */
            visibility: visible; /* Ensure the main title is visible */
        }
        h1.chart-header {
            text-align: center;
            font-size: 58px; /* Increase the font size to 58 */
            margin-bottom: 20px; /* Increase margin-bottom to 20 */
            visibility: hidden; /* Hide the headers initially */
        }
    </style>
    <!-- Include Chart.js library -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Include Moment.js library -->
    <script src="https://cdn.jsdelivr.net/npm/moment"></script>
    <!-- Include Chart.js date adapter -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-moment"></script>
    <!-- Include Chart.js annotation plugin -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation"></script>
    <script>
        async function fetchData(field, channel, apiKey) {
            try {
                const response = await fetch(`https://api.thingspeak.com/channels/${channel}/feeds.json?days=1&apikey=${apiKey}`);
                const data = await response.json();
                
                return data.feeds.map(feed => ({
                    x: new Date(feed.created_at),
                    y: parseFloat(feed[field])
                }));
            } catch (error) {
                console.error('Error fetching data:', error);
                return [];
            }
        }

        function calculateStepSize(data) {
            const yValues = data.map(point => point.y);
            const minY = Math.min(...yValues);
            const maxY = Math.max(...yValues);
            const rangeY = maxY - minY;

            const desiredTicks = 5; // Desired number of ticks
            const stepSize = Math.max(1, Math.ceil(rangeY / desiredTicks));

            return stepSize;
        }

        async function renderChartCO2() {
            const data = await fetchData('field4', '2841427', 'ELN7AALPJ599IZO4');

            const lastDataPoint = data[data.length - 1];

            // Update the header with the last value (no decimal places) and " ppm"
            const headerCO2 = document.getElementById('chartHeaderCO2');
            headerCO2.innerHTML = `CO&#8322;: ${Math.round(lastDataPoint.y)} ppm`;
            headerCO2.style.visibility = 'visible'; // Show the header

            const ctx = document.getElementById('myChartCO2').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [{
                        label: '',
                        data: data,
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 3, // Increase borderWidth to 6
                        fill: false,
                        tension: 0.4
                    }]
                },
                options: {
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'hour',
                                displayFormats: {
                                    hour: 'HH:mm'
                                },
                                tooltipFormat: 'HH:mm'
                            },
                            title: {
                                display: true,
                                text: 'Time',
                                font: {
                                    size: 40, // Increase font size to 40
                                    color: 'black'
                                }
                            },
                            ticks: {
                                font: {
                                    size: 25, // Increase font size to 25
                                    color: 'black'
                                }
                            },
                            grid: {
                                drawBorder: true,
                                borderColor: 'black',
                                borderWidth: 3
                            }
                        },
                        y: {
                            min: 0, // Set minimum value for y-axis
                            title: {
                                display: true,
                                text: 'CO\u2082 [ppm]', 
                                font: {
                                    size: 40, // Increase font size to 40
                                    color: 'black'
                                }
                            },
                            ticks: {
                                font: {
                                    size: 25, // Increase font size to 25
                                    color: 'black'
                                },
                                callback: function(value, index, values) {
                                    return value.toFixed(0); // No decimal places
                                }
                            },
                            grid: {
                                drawBorder: true,
                                borderColor: 'black',
                                borderWidth: 3
                            }
                        }
                    }
                }
            });
        }

        async function renderChartTemperature() {
            const data = await fetchData('field5', '2841427', 'ELN7AALPJ599IZO4'); // Read data from field5

            const lastDataPoint = data[data.length - 1];

            // Update the header with the last value (one decimal place) and "째C"
            const headerTemperature = document.getElementById('chartHeaderTemperature');
            headerTemperature.innerText = `Temperatur: ${lastDataPoint.y.toFixed(1)}째C`;
            headerTemperature.style.visibility = 'visible'; // Show the header

            const stepSize = calculateStepSize(data); // Calculate dynamic step size

            const ctx = document.getElementById('myChartTemperature').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [{
                        label: '',
                        data: data,
                        borderColor: 'rgba(255, 99, 132, 1)', // Different color for temperature chart
                        borderWidth: 3, // Increase borderWidth to 6
                        fill: false,
                        // pointRadius: 0
                        tension: 0.4
                    }]
                },
                options: {
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'hour',
                                displayFormats: {
                                    hour: 'HH:mm'
                                },
                                tooltipFormat: 'HH:mm'
                            },
                            title: {
                                display: true,
                                text: 'Time',
                                font: {
                                    size: 40, // Increase font size to 40
                                    color: 'black'
                                }
                            },
                            ticks: {
                                font: {
                                    size: 25, // Increase font size to 25
                                    color: 'black'
                                }
                            },
                            grid: {
                                drawBorder: true,
                                borderColor: 'black',
                                borderWidth: 3
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Temperatur [째C]', 
                                font: {
                                    size: 40, // Increase font size to 40
                                    color: 'black'
                                }
                            },
                            ticks: {
                                font: {
                                    size: 25, // Increase font size to 25
                                    color: 'black'
                                },
                                stepSize: stepSize, // Set dynamic step size
                                callback: function(value, index, values) {
                                    return value.toFixed(1); // One decimal place
                                }
                            },
                            grid: {
                                drawBorder: true,
                                borderColor: 'black',
                                borderWidth: 3
                            }
                        }
                    }
                }
            });
        }

        async function renderChartHumidity() {
            const data = await fetchData('field6', '2841427', 'ELN7AALPJ599IZO4'); // Read data from field6

            const lastDataPoint = data[data.length - 1];

            // Update the header with the last value (no decimal places) and " %"
            const headerHumidity = document.getElementById('chartHeaderHumidity');
            headerHumidity.innerText = `Luftfeuchtigkeit: ${Math.round(lastDataPoint.y)} %`;
            headerHumidity.style.visibility = 'visible'; // Show the header

            const stepSize = calculateStepSize(data); // Calculate dynamic step size

            const ctx = document.getElementById('myChartHumidity').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [{
                        label: '',
                        data: data,
                        borderColor: 'rgba(54, 162, 235, 1)', // Different color for humidity chart
                        borderWidth: 3, // Increase borderWidth to 6
                        fill: false
                    }]
                },
                options: {
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'hour',
                                displayFormats: {
                                    hour: 'HH:mm'
                                },
                                tooltipFormat: 'HH:mm'
                            },
                            title: {
                                display: true,
                                text: 'Time',
                                font: {
                                    size: 40, // Increase font size to 40
                                    color: 'black'
                                }
                            },
                            ticks: {
                                font: {
                                    size: 25, // Increase font size to 25
                                    color: 'black'
                                }
                            },
                            grid: {
                                drawBorder: true,
                                borderColor: 'black',
                                borderWidth: 3
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Luftfeuchtigkeit [%]', 
                                font: {
                                    size: 40, // Increase font size to 40
                                    color: 'black'
                                }
                            },
                            ticks: {
                                font: {
                                    size: 25, // Increase font size to 25
                                    color: 'black'
                                },
                                stepSize: stepSize, // Set dynamic step size
                                callback: function(value, index, values) {
                                    return value.toFixed(0); // No decimal places
                                }
                            },
                            grid: {
                                drawBorder: true,
                                borderColor: 'black',
                                borderWidth: 3
                            }
                        }
                    }
                }
            });
        }

        async function renderChartBewegung() {
            const data = await fetchData('field1', '2847050', '6B3GVDYR3F766SRJ'); // Read data from field1

            const lastDataPoint = data[data.length - 1];

            // Update the header with the last value (one decimal place) and "째C"
            const headerBewegung = document.getElementById('chartHeaderBewegung');
            headerBewegung.innerText = `Bewegung: ${lastDataPoint.y.toFixed(0)}`;
            headerBewegung.style.visibility = 'visible'; // Show the header

            const stepSize = calculateStepSize(data); // Calculate dynamic step size

            const ctx = document.getElementById('myChartBewegung').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [{
                        label: '',
                        data: data,
                        borderColor: 'rgba(255, 99, 132, 1)', // Different color for temperature chart
                        borderWidth: 3, // Increase borderWidth to 6
                        fill: false,
                        // pointRadius: 0
                        tension: 0.4
                    }]
                },
                options: {
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'hour',
                                displayFormats: {
                                    hour: 'HH:mm'
                                },
                                tooltipFormat: 'HH:mm'
                            },
                            title: {
                                display: true,
                                text: 'Time',
                                font: {
                                    size: 40, // Increase font size to 40
                                    color: 'black'
                                }
                            },
                            ticks: {
                                font: {
                                    size: 25, // Increase font size to 25
                                    color: 'black'
                                }
                            },
                            grid: {
                                drawBorder: true,
                                borderColor: 'black',
                                borderWidth: 3
                            }
                        },
                        y: {
                            min: 0,
                            max: 1,
                            title: {
                                display: true,
                                text: 'Bewegung [0/1]', 
                                font: {
                                    size: 40, // Increase font size to 40
                                    color: 'black'
                                }
                            },
                            ticks: {
                                font: {
                                    size: 25, // Increase font size to 25
                                    color: 'black'
                                },
                                stepSize: stepSize, // Set dynamic step size
                                callback: function(value, index, values) {
                                    return value.toFixed(0); // One decimal place
                                }
                            },
                            grid: {
                                drawBorder: true,
                                borderColor: 'black',
                                borderWidth: 3
                            }
                        }
                    }
                }
            });
        }

        window.onload = function () {
            renderChartCO2();
            renderChartTemperature();
            renderChartHumidity();
            renderChartBewegung();
        };
    </script>
</head>
<body>

<!-- Main title for the page -->
<h1 class="main-title">B&uuml;ro</h1>

<!-- Header to display the last CO2 value using h1 -->
<h1 id="chartHeaderCO2" class="chart-header">CO&#8322;</h1>
<div class="chart-container">
    <canvas id="myChartCO2" width="900" height="600"></canvas>
</div>

<!-- Header to display the last Temperature value using h1 -->
<h1 id="chartHeaderTemperature" class="chart-header">Temperatur</h1>
<div class="chart-container">
    <canvas id="myChartTemperature" width="900" height="600"></canvas>
</div>

<!-- Header to display the last Humidity value using h1 -->
<h1 id="chartHeaderHumidity" class="chart-header">Luftfeuchtigkeit</h1>
<div class="chart-container">
    <canvas id="myChartHumidity" width="900" height="600"></canvas>
</div>

<!-- Header to display the last Bewegung value using h1 -->
<h1 id="chartHeaderBewegung" class="chart-header">Bewegung</h1>
<div class="chart-container">
    <canvas id="myChartBewegung" width="900" height="600"></canvas>
</div>

</body>
</html>

